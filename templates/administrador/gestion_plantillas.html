{% extends "administrador/base_admin.html" %}

{% block title %}Gestión de Plantillas{% endblock %}
{% block page_title %}Gestión de Plantillas{% endblock %}

{% block content %}
<!-- Formulario para subir nueva plantilla -->
<div class="card-custom mb-5">
    <div class="card-header-custom d-flex align-items-center justify-content-between">
        <h3 class="mb-0" style="font-size: var(--font-size-xl);">
            <i class="fas fa-file-upload" style="margin-right: var(--spacing-sm); color: var(--color-primary);"></i>
            Subir Nueva Plantilla
        </h3>
    </div>
    <div class="card-body-custom">
        <form method="post" enctype="multipart/form-data" class="form-section-custom mb-0" style="border: none; padding: 0; box-shadow: none;">
            {% csrf_token %}

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--spacing-xl);">
                <!-- Columna 1 -->
                <div>
                    <div class="form-group-custom">
                        <label for="nombre" class="form-label-custom">
                            Nombre de la Plantilla <span style="color: var(--color-danger);">*</span>
                        </label>
                        <div style="position: relative;">
                            <i class="fas fa-tag" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted);"></i>
                            <input type="text"
                                   class="form-input-custom"
                                   style="padding-left: 2.5rem;"
                                   id="nombre"
                                   name="nombre"
                                   placeholder="Ej: Visa de Turista USA"
                                   required>
                        </div>
                        <span style="font-size: var(--font-size-xs); color: var(--color-text-secondary); margin-top: var(--spacing-xs); display: block;">
                            Nombre descriptivo para identificar la plantilla internamente.
                        </span>
                    </div>

                    <div class="form-group-custom">
                        <label for="segmento" class="form-label-custom">
                            Segmento <span style="color: var(--color-danger);">*</span>
                        </label>
                        <div style="position: relative;">
                            <i class="fas fa-folder" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-text-muted);"></i>
                            <input type="text"
                                   class="form-input-custom"
                                   style="padding-left: 2.5rem;"
                                   id="segmento"
                                   name="segmento"
                                   placeholder="Ej: Visas, Residencias"
                                   required>
                        </div>
                        <span style="font-size: var(--font-size-xs); color: var(--color-text-secondary); margin-top: var(--spacing-xs); display: block;">
                            Categoría principal del trámite.
                        </span>
                    </div>
                </div>

                <!-- Columna 2 -->
                <div>
                    <div class="form-group-custom">
                        <label for="archivo_base" class="form-label-custom">
                            Archivo PDF <span style="color: var(--color-danger);">*</span>
                        </label>
                        <div style="position: relative;">
                            <input type="file"
                                   class="form-input-custom"
                                   id="archivo_base"
                                   name="archivo_base"
                                   accept=".pdf"
                                   required
                                   style="padding: 0.5rem;">
                        </div>
                        <span style="font-size: var(--font-size-xs); color: var(--color-text-secondary); margin-top: var(--spacing-xs); display: block;">
                            Solo archivos PDF (máx. 10MB).
                        </span>
                    </div>

                    <!-- Campo oculto Tipo Específico (se sincroniza con Nombre) -->
                    <input type="hidden" id="tipo_especifico" name="tipo_especifico">
                </div>
            </div>

            <div class="d-flex justify-content-end mt-4 pt-4" style="border-top: 1px solid var(--color-border-light);">
                <button type="submit" class="btn-custom btn-primary-custom">
                    <i class="fas fa-save"></i>
                    <span>Guardar Plantilla</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Lista de plantillas existentes -->
<div class="card-custom">
    <div class="card-header-custom">
        <h3 class="mb-0" style="font-size: var(--font-size-xl);">
            <i class="fas fa-list-alt" style="margin-right: var(--spacing-sm); color: var(--color-primary);"></i>
            Plantillas Existentes
        </h3>
    </div>
    <div class="card-body-custom">
        {% if plantillas %}
            <div style="overflow-x: auto;">
                <table class="table-custom">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Segmento</th>
                            <th>Subido por</th>
                            <th>Fecha</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for plantilla in plantillas %}
                        <tr>
                            <td>
                                <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                                    <i class="fas fa-file-pdf" style="color: var(--color-danger);"></i>
                                    <strong>{{ plantilla.nombre }}</strong>
                                </div>
                            </td>
                            <td>
                                <span class="badge-custom badge-info">
                                    <i class="fas fa-folder"></i>
                                    <span>{{ plantilla.segmento }}</span>
                                </span>
                            </td>
                            <td style="color: var(--color-text-secondary);">
                                {{ plantilla.administrador.nombre|default:"N/A" }}
                            </td>
                            <td>{{ plantilla.fecha_creacion|date:"d/m/Y" }}</td>
                            <td>
                                <div style="display: flex; gap: var(--spacing-sm);">
                                    {% if plantilla.archivo_base %}
                                        <button type="button"
                                           class="btn-custom btn-secondary-custom"
                                           style="padding: 0.5rem 1rem; font-size: var(--font-size-xs);"
                                           onclick="showPdfViewer('{{ plantilla.archivo_base.url }}', '{{ plantilla.nombre }}')"
                                           title="Ver PDF">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <a href="{{ plantilla.archivo_base.url }}"
                                           class="btn-custom btn-outline-custom"
                                           style="padding: 0.5rem 1rem; font-size: var(--font-size-xs);"
                                           download="{{ plantilla.nombre }}.pdf"
                                           title="Descargar">
                                            <i class="fas fa-download"></i>
                                        </a>
                                    {% else %}
                                        <span style="color: var(--color-text-muted); font-size: var(--font-size-sm);">
                                            Sin archivo
                                        </span>
                                    {% endif %}
                                    <button type="button"
                                            class="btn-custom btn-danger-custom"
                                            style="padding: 0.5rem 1rem; font-size: var(--font-size-xs);"
                                            onclick="showDeletePlantillaModal({{ plantilla.id }}, '{{ plantilla.nombre }}')"
                                            title="Eliminar plantilla">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div style="text-align: center; padding: var(--spacing-2xl) var(--spacing-lg);">
                <i class="fas fa-file-pdf" style="font-size: 3rem; color: var(--color-border); margin-bottom: var(--spacing-lg);"></i>
                <p style="color: var(--color-text-muted); margin: 0;">
                    No hay plantillas subidas. Suba la primera plantilla usando el formulario anterior.
                </p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Visor de PDF embebido -->
<div id="pdfViewerCard" class="card-custom mt-5" style="display: none;">
    <div class="card-header-custom d-flex align-items-center justify-content-between">
        <h3 id="pdfViewerTitle" class="mb-0" style="font-size: var(--font-size-xl);">
            <i class="fas fa-file-pdf" style="margin-right: var(--spacing-sm); color: var(--color-danger);"></i>
            <span></span>
        </h3>
        <button type="button" class="btn-custom btn-secondary-custom" onclick="hidePdfViewer()">
            <i class="fas fa-times"></i>
            <span>Cerrar</span>
        </button>
    </div>
    <div class="card-body-custom" style="padding: 0;">
        <iframe id="pdfViewerFrame" style="width: 100%; height: 75vh; border: none;"></iframe>
    </div>
</div>

<!-- Modal de confirmación de eliminación -->
<div id="deletePlantillaModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
    <div style="background: var(--color-surface); border-radius: var(--border-radius-lg); padding: var(--spacing-xl); max-width: 500px; width: 90%; box-shadow: var(--shadow-xl);">
        <div style="display: flex; align-items: center; gap: var(--spacing-md); margin-bottom: var(--spacing-lg);">
            <div style="width: 48px; height: 48px; background: var(--color-danger-light); border-radius: var(--border-radius-md); display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-exclamation-triangle" style="font-size: var(--font-size-xl); color: var(--color-danger);"></i>
            </div>
            <h3 style="font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold); margin: 0;">
                Confirmar Eliminación
            </h3>
        </div>
        <p style="color: var(--color-text-secondary); margin-bottom: var(--spacing-lg);">
            ¿Está seguro de que desea eliminar la plantilla <strong id="deletePlantillaName"></strong>? Esta acción no se puede deshacer.
        </p>
        <form method="post" id="deletePlantillaForm">
            {% csrf_token %}
            <input type="hidden" name="plantilla_id" id="deletePlantillaId">
            <input type="hidden" name="eliminar_plantilla" value="1">
            <div style="display: flex; gap: var(--spacing-md); justify-content: flex-end;">
                <button type="button" class="btn-custom btn-secondary-custom" onclick="hidePlantillaModal()">
                    Cancelar
                </button>
                <button type="submit" class="btn-custom btn-danger-custom">
                    <i class="fas fa-trash"></i>
                    <span>Eliminar Plantilla</span>
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function showDeletePlantillaModal(id, nombre) {
    document.getElementById('deletePlantillaName').textContent = nombre;
    document.getElementById('deletePlantillaId').value = id;
    document.getElementById('deletePlantillaModal').style.display = 'flex';
}

function hidePlantillaModal() {
    document.getElementById('deletePlantillaModal').style.display = 'none';
}

// Cerrar modal al hacer clic fuera
document.getElementById('deletePlantillaModal').addEventListener('click', function(e) {
    if (e.target === this) {
        hidePlantillaModal();
    }
});

// Sincronizar Nombre con Tipo Específico
document.addEventListener('DOMContentLoaded', function() {
    const nombreInput = document.getElementById('nombre');
    const tipoEspecificoInput = document.getElementById('tipo_especifico');

    if (nombreInput && tipoEspecificoInput) {
        nombreInput.addEventListener('input', function() {
            tipoEspecificoInput.value = this.value;
        });
        tipoEspecificoInput.value = nombreInput.value;
    }
});

// --- Funciones del Visor de PDF ---
function showPdfViewer(pdfUrl, pdfName) {
    const viewerCard = document.getElementById('pdfViewerCard');
    const viewerTitle = document.getElementById('pdfViewerTitle').querySelector('span');
    const viewerFrame = document.getElementById('pdfViewerFrame');

    viewerTitle.textContent = pdfName;
    viewerFrame.src = pdfUrl;
    viewerCard.style.display = 'block';

    // Scroll para que el visor sea visible
    viewerCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function hidePdfViewer() {
    const viewerCard = document.getElementById('pdfViewerCard');
    const viewerFrame = document.getElementById('pdfViewerFrame');

    viewerCard.style.display = 'none';
    viewerFrame.src = ''; // Detiene la carga del PDF para liberar recursos
}
</script>
{% endblock %}